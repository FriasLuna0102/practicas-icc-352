<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Plantilla General</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-image: url("../img/6fe01f5fbe372a2b045f66a79be7b210.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            width: 100%;
            height: 100%;
        }

        h1 {
            color: white;
        }
    </style>

    <link rel="stylesheet" type="" href="../js/offline-theme-slide-indicator.css">
    <link rel="stylesheet" type="" href="../js/offline-language-spanish-indicator.css">
    <script src="../js/offline.js">
    </script>
    <script>
        Offline.options = {
            checks: {
                xhr: {
                    url: '/autenticar', // Cambia esto a una URL válida en tu sitio
                    timeout: 5, // Tiempo de espera para la solicitud
                },
                // Otros tipos de verificaciones según tus necesidades
            },
            // Verificar el estado de conexión al cargar la página.
            checkOnLoad: true,
            // Monitorear las solicitudes AJAX para verificar la conexión.
            interceptRequests: true,
            // Volver a probar automáticamente periódicamente cuando la conexión está inactiva.
            reconnect: {
                // Retraso en segundos antes de volver a verificar.
                initialDelay: 3,
                // Intervalo de espera en segundos entre reintentos.
                delay: 10
            },
            // Almacenar y volver a intentar solicitudes que fallaron mientras la conexión estaba inactiva.
            requests: true
        };
        Offline.check()
    </script>

</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="navbar-header">
            <!-- Botón de Login -->
            <span th:if="${usuario != null}">

                <span th:text="${usuario.nombre}" style="color: white;"></span>
                <a class="btn btn-sm btn-primary navbar-btn" href="/logout">Logout</a>

            </span>
            <!-- Nombre del usuario -->
            <span th:if="${usuario == null}">
                <a class="btn btn-sm btn-primary navbar-btn" href="/login">Login</a>

            </span>
            <!-- ... -->
        </div>




    </nav>


    <div class="container mt-5 text-center">

        <h1>Bienvenido <span th:text="${usuario.getNombre}"></span></h1>
    </div>

    <div class="container mt-5 text-center">
        <div class="my-3">
            <button class="btn btn-primary"
                onclick="window.location.href = '/html/formulario.html';">Formulario</button>
        </div>

    <div class="my-3">
        <button class="btn btn-secondary" onclick="window.location.href='/html/mapa.html'">Mapa</button>
    </div>

        <div class="my-3">
            <button class="btn btn-success"
                onclick="window.location.href = '/plantillaGeneral/administrarUsuarios';">Administrar Usuarios</button>
        </div>

    <div class="my-3">
        <button class="btn btn-danger" onclick="conectar()">Sincronizar</button>
    </div>

        <div class="my-3">
            <button class="btn btn-warning"
                onclick="window.location.href = '/html/administrarRegistros.html';">Administrar Registros</button>
        </div>
    </div>

<!-- JavaScript para manejar la sincronización con WebSockets -->
<script>
    function conectar(){

        // Conectar con el servidor WebSocket
        const socket = new WebSocket("ws://"+location.hostname+":"+location.port+"/plantillaGeneral/sincronizar"); // Cambia la URL por la del servidor WebSocket

        // Manejar la apertura de la conexión WebSocket
        socket.onopen = function() {
            console.log('Conexión establecida con el servidor WebSocket');

            // Recuperar registros de IndexedDB
            var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            var request = indexedDB.open("FormularioDB", 1);

            request.onerror = function(event) {
                console.error('Error al abrir la base de datos:', event.target.errorCode);
            };

            request.onsuccess = function(event) {
                var db = event.target.result;
                var transaction = db.transaction(["formularios"], "readwrite"); // Cambiar a modo de escritura
                var objectStore = transaction.objectStore("formularios");
                var formularios = [];

                // Obtener registros con estado = 0
                objectStore.openCursor().onsuccess = function(event) {
                    var cursor = event.target.result;
                    if (cursor) {
                        if (cursor.value.estado === 0) {
                            // Actualizar el estado del registro a 1
                            cursor.value.estado = 1;
                            var updateRequest = cursor.update(cursor.value);
                            updateRequest.onsuccess = function() {
                                console.log("Estado actualizado a 1 para el registro con ID: " + cursor.value.id);
                            };
                            updateRequest.onerror = function() {
                                console.error("Error al actualizar el estado del registro");
                            };
                            formularios.push(cursor.value);
                        }
                        cursor.continue();
                    } else {
                        // Enviar registros al servidor WebSocket
                        socket.send(JSON.stringify(formularios));
                    }
                };
            };

        };

        // Manejar los errores de la conexión WebSocket
        socket.onerror = function(error) {
            console.error('Error en la conexión WebSocket:', error);
        };

        // Manejar los mensajes recibidos del servidor WebSocket
        socket.onmessage = function(event) {
            console.log('Mensaje recibido del servidor WebSocket:', event.data);
            // Puedes agregar aquí la lógica para manejar la respuesta del servidor si es necesario
        };
    }
</script>


</body>

</html>
